import React, { useEffect, Suspense, lazy } from "react";
import { Route, Switch } from "react-router-dom";
import Spinner from "components/spinner/spinner";
import { ToastContainer } from "react-toastify";
import "react-toastify/dist/ReactToastify.css";
import "styles/main.scss";

import { connect } from "react-redux";
import {
  fetchProjectsStart,
  fetchMyProjectsStart
} from "redux/project/project.action";
import { fetchCorporateStart } from "redux/corporate/corporate.action";
import { fetchDescStart } from "redux/desc/desc.action";
import { fetchUsersStart } from "redux/user/user.action";

const Login = lazy(() => import("pages/login/login"));
const Register = lazy(() => import("pages/register/register"));
const Main = lazy(() => import("./Main"));

const App = ({
  fetchDesc,
  fetchProjects,
  fetchUsers,
  fetchCorporate,
  fetchMyProjects
}) => {
  const user = JSON.parse(localStorage.getItem("currentUser"));

  useEffect(() => {
    !!user && fetchProjects();
  }, [fetchProjects, user]);

  useEffect(() => {
    !!user && fetchCorporate();
  }, [fetchCorporate, user]);

  useEffect(() => {
    !!user && fetchDesc();
  }, [fetchDesc, user]);

  useEffect(() => {
    !!user && fetchUsers();
  }, [fetchUsers, user]);

  useEffect(() => {
    !!user && fetchMyProjects();
  }, [fetchMyProjects, user]);

  return (
    <div>
      <Switch>
        <Suspense fallback={<Spinner />}>
          <Route exact path="/register" component={Register} />
          <Route exact path="/login" component={Login} />
          <Route path="/" component={Main} />
        </Suspense>
      </Switch>
      <ToastContainer autoClose={3500} />
    </div>
  );
};

const mapDispatchToProps = dispatch => ({
  fetchProjects: () => dispatch(fetchProjectsStart()),
  fetchCorporate: () => dispatch(fetchCorporateStart()),
  fetchDesc: () => dispatch(fetchDescStart()),
  fetchUsers: () => dispatch(fetchUsersStart()),
  fetchMyProjects: () => dispatch(fetchMyProjectsStart())
});

export default connect(null, mapDispatchToProps)(App);
