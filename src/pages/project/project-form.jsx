import React, { Component } from "react";
import { createStructuredSelector } from "reselect";
import { connect } from "react-redux";
import { withRouter } from "react-router-dom";
import { Form, Field } from "react-final-form";
import { TextField } from "final-form-material-ui";
import { Paper, Grid, Button, MenuItem, Chip } from "@material-ui/core";
import { MuiPickersUtilsProvider } from "@material-ui/pickers";
import DateFnsUtils from "@date-io/date-fns";
import DatePickerWrapper from "components/date-picker/date-picker";
import {
  addProjectStart,
  fetchProjectByIdStart,
  updateProjectStart
} from "redux/project/project.action";
import { selectProjectById } from "redux/project/project.selector";
import { selectAllUser } from "redux/user/user.selector";
import SelectMulti from "components/multi-select/multi-select";
import { projectValidation } from "utils/validate";

class ProjectForm extends Component {
  state = {
    user: [],
    target: {}
  };

  onSubmit = async values => {
    const { projectId, id } = this.props.match.params;
    const { addProject, history, updateProject } = this.props;
    const { user, target } = this.state;

    let team = [];
    user.length
      ? (team = user.map(user => user._id))
      : (team = values.team.map(user => user._id) || []);

    delete values.team;

    let n = 0;
    const initial = {};
    const hasil = team.reduce((obj, item) => {
      return {
        ...obj,
        [`team[${n++}]`]: item
      };
    }, initial);

    const newValues = { ...values, corporateId: id, target };
    const f_values = Object.assign(hasil, newValues);

    projectId ? updateProject(projectId, f_values) : addProject(f_values);

    history.goBack();
  };

  handleChange = event => {
    const { value } = event.target;
    const newValue = [...value];
    this.setState({ user: newValue });
  };

  handleFileChange = e => {
    const target = e.target.files[0];
    this.setState({ target });
  };

  componentDidMount() {
    const { projectId } = this.props.match.params;
    const { fetchProjectById } = this.props;
    !!projectId && fetchProjectById(projectId);
  }

  render() {
    const { onSubmit, handleChange } = this;
    const { history, project, users } = this.props;
    const { user } = this.state;
    const { team } = project;

    return (
      <div className="customed_form">
        <div className="center">
          <h2>Add/Edit Project</h2>
        </div>
        <Form
          onSubmit={onSubmit}
          initialValues={{ ...project }}
          validate={projectValidation}
          render={({ handleSubmit, pristine, values }) => (
            <form onSubmit={handleSubmit} noValidate>
              <Paper className="customed_form-content">
                <Grid container alignItems="flex-start" spacing={2}>
                  <Grid item xs={12}>
                    <Field
                      fullWidth
                      required
                      name="name"
                      component={TextField}
                      type="text"
                      label="Project Name"
                    />
                  </Grid>
                  <Grid item xs={12}>
                    <Field
                      name="description"
                      component={TextField}
                      fullWidth
                      margin="normal"
                      label="Project Description"
                    />
                  </Grid>
                  <MuiPickersUtilsProvider utils={DateFnsUtils}>
                    <Grid item xs={6}>
                      <Field
                        name="startDate"
                        component={DatePickerWrapper}
                        fullWidth
                        margin="normal"
                        label="Start Date Pentest"
                      />
                    </Grid>
                    <Grid item xs={6}>
                      <Field
                        name="endDate"
                        component={DatePickerWrapper}
                        fullWidth
                        margin="normal"
                        label="End Date Pentest"
                      />
                    </Grid>
                  </MuiPickersUtilsProvider>
                  <MuiPickersUtilsProvider utils={DateFnsUtils}>
                    <Grid item xs={6}>
                      <Field
                        name="reportStartDate"
                        component={DatePickerWrapper}
                        fullWidth
                        margin="normal"
                        label="Start Date Report"
                      />
                    </Grid>
                    <Grid item xs={6}>
                      <Field
                        name="reportEndDate"
                        component={DatePickerWrapper}
                        fullWidth
                        margin="normal"
                        label="End Date Report"
                      />
                    </Grid>
                  </MuiPickersUtilsProvider>
                  <Grid item xs={6} className="team-field">
                    <Field
                      input={{
                        name: "team",
                        onChange: handleChange,
                        value: user
                      }}
                      name="team"
                      label="Team"
                      component={SelectMulti}
                      formControlProps={{ fullWidth: true }}
                    >
                      {users.map(user => (
                        <MenuItem key={user._id} value={user}>
                          {user.name}
                        </MenuItem>
                      ))}
                    </Field>
                    <div className="current-team">
                      Current team :
                      {team &&
                        team.map(element => (
                          <Chip
                            className="medium-size"
                            variant="outlined"
                            key={element._id}
                            label={element.name}
                          />
                        ))}
                    </div>
                  </Grid>
                  <Grid item xs={6}>
                    <p>Upload Target</p>
                    <input
                      onChange={e => this.handleFileChange(e)}
                      type="file"
                      name="target"
                    />
                  </Grid>
                </Grid>

                <Grid
                  item
                  xs={12}
                  style={{
                    marginTop: 16,
                    display: "flex",
                    justifyContent: "flex-end"
                  }}
                >
                  <Button
                    variant="contained"
                    color="default"
                    className="u-margin-right-small medium-size"
                    onClick={() => history.goBack()}
                  >
                    Cancel
                  </Button>

                  <Button
                    variant="contained"
                    color="primary"
                    type="submit"
                    className="medium-size"
                  >
                    Submit
                  </Button>
                </Grid>
              </Paper>
            </form>
          )}
        />
      </div>
    );
  }
}

const mapStateToProps = createStructuredSelector({
  project: selectProjectById,
  users: selectAllUser
});

const mapDispatchToProps = dispatch => ({
  addProject: form => dispatch(addProjectStart(form)),
  fetchProjectById: id => dispatch(fetchProjectByIdStart(id)),
  updateProject: (id, form) => dispatch(updateProjectStart(id, form))
});
export default withRouter(
  connect(mapStateToProps, mapDispatchToProps)(ProjectForm)
);
